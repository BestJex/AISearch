<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="/css/element-ui.min.css">
    <link rel="stylesheet" href="/css/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/my-select.css">
    <link rel="stylesheet" href="/css/my-index.css">
    <link rel="stylesheet" href="/css/APlayer.min.css">
</head>
<body>
<script type="text/javascript" th:inline="javascript">
    var msg = [[${msg}]];
</script>
<div id="app" class="search" style="display: none">
    <div class="aplayer" id="player" style="display: none;color:black"
         data-id="402192905"
         data-fixed="true"
         data-server="netease"
         data-volume="0.4"
         data-type="playlist">
    </div>
    <div @click="toggle" @keyup.enter="toDetails(store.keyword)">
        <!--notePlaceholder考虑动态变化,比如,小知识,小技巧,温馨的话,历史事件之类的,不要固定死-->
        <el-input type="textarea" autosize :placeholder="store.notePlaceholder" class="textarea" v-model="store.note"
                  :style="{display:isSee}"
        ></el-input>
        <!--notePlaceholder考虑动态变化,比如,小知识,小技巧,温馨的话,历史事件之类的,不要固定死,输入框也考虑动态加点东西,根据用户习惯,几秒滚动哈,用placeholder实现-->
        <el-input autofocus id="el-input" style="width: 500px;"
                  @input="searchItem(store.keyword)"
                  placeholder="搜你想要"
                  v-model="store.keyword">
        </el-input>
        <ul style="position: absolute;overflow-y: auto;overflow-x: hidden;width:500px;height:250px;" v-show="isShow">
            <li @click="upScreen(item.title==null?item.answer:item.title)" v-for="item in store.article"
                :value="item.id"
                :style="{width : width +'px',height:height +'px'}" th:class="li">
                {{item.title==null?item.answer:item.title}}
            </li>
        </ul>
    </div>

</div>
</body>
<script src="/js/jquery-1.9.1.min.js"></script>
<script src="/js/vue.min.js" type="text/javascript"></script>
<script src="/js/element-ui.min.js" type="text/javascript"></script>
<!--<link href="https://cdn.bootcss.com/element-ui/2.7.2/theme-chalk/index.css" rel="stylesheet">-->
<script src="/js/my-select.js" type="text/javascript"></script>
<script src="/js/APlayer.min.js"></script>
<script src="/js/Meting.min.js"></script>
<script>
    var store = {
        IsShow:false,
        pattern: "",
        notePlaceholder: "写点什么吧～～",
        note: "",
        isSee: 'none',
        visible: false,
        width: 0,
        height: 40,
        message: 'AISearch',
        keyword: "",
        isShow: false,
        article: [],
        msg: msg
    };
    var app = new Vue({
        el: '#app',
        data: store,
        created: function () {
            $("#app").show();
            if (this.msg != null) {
                this.tips();
            }
            this.width = $("#el-input").width();
        },
        watch: {
            /*用于监听关键字,如果为空,隐藏ul框*/
            keyword: function () {
                if (this.keyword == "") {
                    this.isShow = false;
                }
            }
        },
        methods: {
            tips: function () {
                this.$message(msg);
            },
            //enter或者button激发,用于记录用户上下文
            toDetails: function (keyword) {
                if (keyword != "") {
                    /*如果/开头,跳转到对应页面*/
                    var isForward = keyword.startsWith('/');
                    /*转发模式*/
                    if (isForward) {
                        window.location.href = keyword.substring(1);
                        /*调用下面的函数*/
                    } else {
                        this.toDetail(keyword);
                    }
                }
            },
            toDetail: function (keyword) {
                var isNote = keyword.startsWith('"');
                var isCommand = keyword.startsWith(":")
                /*便签模式*/
                if (isNote) {
                    $.ajax({
                        type: "post",
                        contentType: "application/json",
                        url: "/note",
                        data: JSON.stringify({
                            "keyword": keyword.substring(1)
                        }),
                        success: function (data) {

                            if (data == "nologin") {
                                window.location.href = "/login";
                            } else {
                                if (store.note == "") {
                                    store.note = data.concat("---").concat(new Date().toLocaleString());
                                } else {
                                    store.note += "\n".concat(data).concat("---").concat(new Date().toLocaleString());
                                }
                                store.keyword = "";
                            }
                        }
                    });
                    /*命令模式*/
                } else if (isCommand) {
                    var index = keyword.indexOf(" ");
                    if (index != -1) {
                        var command = keyword.substring(1, index + 1);
                        var title = keyword.substring(index + 1);
                        var end = keyword.lastIndexOf(" ");
                        if (command == "zh ") {
                            store.pattern = ":" + command;
                            if (title != "") {
                                this.isShow = true;
                                $.ajax({
                                    url: "/iscommand",
                                    data: {keyword: keyword.substring(1, keyword.length - 1)},
                                    success: function (data) {
                                        window.location.href = "zhihucommandlist";
                                    }
                                });
                            }
                            return;
                        }
                        if (end + 1 == keyword.length) {
                            store.pattern = ":" + command;
                            if (store.pattern == ":logout ") {
                                window.location.href = "/logout";
                            } else if (store.pattern == ":music ") {
                                this.IsShow = !this.IsShow;
                                if (this.IsShow) {
                                    $("#player").show();
                                } else {
                                    $("#player").hide();
                                }
                            }
                            else {
                                if (title != "") {
                                    this.isShow = true;
                                    $.ajax({
                                        url: "/iscommand",
                                        data: {keyword: keyword.substring(1, keyword.length - 1)},
                                        success: function (data) {
                                            window.location.href = "commandlist";
                                        }
                                    });
                                }
                            }
                        }
                    }
                    /*正常搜索*/
                } else {
                    $.ajax({
                        type: "post",
                        contentType: "application/json;charset=utf-8",
                        url: "/todetail",
                        data: JSON.stringify({
                            "keyword": keyword
                        }),
                        success: function (data) {
                            window.location.href = "detail";
                        }
                    });
                }
            },
            searchItem: function (keyword) {
                /*是否"开头*/
                var isNote = keyword.startsWith('\"');
                /*是否/开头*/
                var isForward = keyword.startsWith('/');
                /*是否:开头*/
                var isCommand = keyword.startsWith(':');
                /*开启转发模式,什么都不做,不向后台提交数据*/
                if (isForward) {
                    /*开启命令模式*/
                } else if (isCommand) {
                    var index = keyword.indexOf(" ");
                    if (index != -1) {
                        var command = keyword.substring(1, index + 1);
                        var title = keyword.substring(index + 1);
                        var end = keyword.lastIndexOf(" ");
                        if (end + 1 == keyword.length) {
                            store.pattern = ":" + command;
                            if (title != "") {
                                this.isShow = true;
                                $.ajax({
                                    url: "/command",
                                    data: {keyword: keyword.substring(1, keyword.length - 1)},
                                    success: function (data) {
                                        store.article = [];
                                        for (var i = 0; i < data.length; i++) {
                                            store.article.push(data[i]);
                                        }
                                    }
                                });
                            }
                        }
                    }
                    /*开启便签模式*/
                } else if (isNote) {
                    store.isSee = "block";
                    /*关闭便签模式*/
                } else if (keyword == "") {
                    store.isSee = "none";
                    store.article = [];
                    /*正常模式,提交关键字到后台查询*/
                } else {
                    this.isShow = true;
                    $.ajax({
                        url: "/searchItem", data: {keyword: keyword}, success: function (data) {
                            store.article = [];
                            for (var i = 0; i < data.length; i++) {
                                store.article.push(data[i]);
                            }
                        }
                    })
                }
            },
            toggle: function () {
                this.isShow = !this.isShow;
            },
            blur: function () {
                this.isShow = false;
            },

            upScreen: function (label) {
                if (store.pattern == ":js ") {
                    store.keyword = ":js " + label + " ";
                    $("#el-input").focus();
                } else if (store.pattern == ":csdn ") {
                    store.keyword = ":csdn " + label + " ";
                    $("#el-input").focus();
                } else if (store.pattern == ":zh ") {
                    store.keyword = ":zh " + label.substring(0, 10) + " ";
                    $("#el-input").focus();
                }
                else {
                    store.keyword = label;
                    $("#el-input").focus();
                }
            },
        }
    })

</script>
</html>